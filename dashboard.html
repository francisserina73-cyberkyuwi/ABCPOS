<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABC POS - Dashboard</title>
    <link rel="stylesheet" href="dashboard-styles.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>ABC POS</h1>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link active">
                    <span class="nav-icon dashboard"></span>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="menu.html" class="nav-link">
                    <span class="nav-icon menu"></span>
                    Menu
                </a>
            </li>
            <li class="nav-item nav-inventory" style="display: none;">
                <a href="inventory.html" class="nav-link">
                    <span class="nav-icon inventory"></span>
                    Inventory
                </a>
            </li>
            <li class="nav-item">
                <a href="reports.html" class="nav-link">
                    <span class="nav-icon reports"></span>
                    Reports
                </a>
            </li>
            <li class="nav-item">
                <a href="orders.html" class="nav-link">
                    <span class="nav-icon orders"></span>
                    Orders
                </a>
            </li>
        </ul>
        
        <a href="#" class="logout-btn" id="logoutBtn">
            <span class="logout-icon"></span>
            Logout
        </a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div class="header-left">
                <div class="page-title">
                    <h2>Dashboard</h2>
                    <p>Welcome back, <span id="userName">User</span>!</p>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">üì¶</div>
                <div class="stat-content">
                    <p class="stat-label">Total Products</p>
                    <h3 class="stat-value" id="totalProducts">0</h3>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon orange">‚ö†Ô∏è</div>
                <div class="stat-content">
                    <p class="stat-label">Low Stock Items</p>
                    <h3 class="stat-value" id="lowStock">0</h3>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon green">üí∞</div>
                <div class="stat-content">
                    <p class="stat-label">Today's Sales</p>
                    <h3 class="stat-value" id="todaySales">‚Ç±0.00</h3>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon purple">üìä</div>
                <div class="stat-content">
                    <p class="stat-label">Orders Today</p>
                    <h3 class="stat-value" id="ordersToday">0</h3>
                </div>
            </div>
        </div>

        <!-- Products Sections -->
        <div class="products-container">
            <div class="product-section">
                <div class="section-header">
                    <h3>Popular Products</h3>
                    <a href="inventory.html">View All ‚Üí</a>
                </div>
                <div class="product-grid" id="popularProducts">
                    <div class="loading">Loading products...</div>
                </div>
            </div>

            <div class="product-section">
                <div class="section-header">
                    <h3>Desserts</h3>
                    <a href="inventory.html?category=Dessert">View All ‚Üí</a>
                </div>
                <div class="product-grid" id="dessertProducts">
                    <div class="loading">Loading products...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { requireAuth, getCurrentUser, signOut } from './js/auth.js';
        import { getDashboardStats, getProducts } from './js/api.js';
        import { supabase } from './js/supabase-client.js';
        import { formatCurrency, showToast } from './js/utils.js';

        // Protect page - require authentication
        await requireAuth();

        // Get current user
        const { user } = await getCurrentUser();
        if (user) {
            document.getElementById('userName').textContent = user.profile.full_name || user.email;
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load stats
                const { data: stats, error: statsError } = await getDashboardStats();
                if (!statsError && stats) {
                    document.getElementById('totalProducts').textContent = stats.total_products || 0;
                    document.getElementById('lowStock').textContent = stats.low_stock_items || 0;
                    document.getElementById('todaySales').textContent = formatCurrency(stats.total_sales_today || 0);
                    document.getElementById('ordersToday').textContent = stats.total_orders_today || 0;
                }

                // Load popular products (active products, sorted by stock descending)
                const { data: products, error: productsError } = await getProducts({ status: 'active' });
                if (!productsError && products) {
                    // Sort by stock (highest first) and take top 4
                    const popular = products.sort((a, b) => b.stock - a.stock).slice(0, 4);
                    renderProducts(popular, 'popularProducts');

                    // Filter desserts
                    const desserts = products.filter(p => p.category === 'Dessert').slice(0, 4);
                    renderProducts(desserts, 'dessertProducts');
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
                showToast('Failed to load dashboard data', 'error');
            }
        }

        // Render products
        function renderProducts(products, containerId) {
            const container = document.getElementById(containerId);
            
            if (!products || products.length === 0) {
                container.innerHTML = '<p style="color: #64748b;">No products available</p>';
                return;
            }

            container.innerHTML = products.map(product => `
                <div class="product-card">
                    <img src="${product.image_path || 'https://via.placeholder.com/100'}" 
                         alt="${product.name}"
                         onerror="this.src='https://via.placeholder.com/100'">
                    <div class="product-info">
                        <h4>${product.name}</h4>
                        <p class="product-price">${formatCurrency(product.price)}</p>
                        <p class="product-stock ${product.stock < 10 ? 'low-stock' : ''}">
                            Stock: ${product.stock}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        // Setup real-time updates
        function setupRealtime() {
            // Subscribe to products changes
            const productsSubscription = supabase
                .channel('dashboard-products')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'products' },
                    (payload) => {
                        console.log('Product changed:', payload);
                        loadDashboard(); // Reload dashboard
                        showToast('Data updated', 'info', 2000);
                    }
                )
                .subscribe();

            // Subscribe to orders changes
            const ordersSubscription = supabase
                .channel('dashboard-orders')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'orders' },
                    (payload) => {
                        console.log('Order changed:', payload);
                        loadDashboard(); // Reload dashboard
                        showToast('New order received', 'success', 2000);
                    }
                )
                .subscribe();

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                supabase.removeChannel(productsSubscription);
                supabase.removeChannel(ordersSubscription);
            });
        }

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const result = await signOut();
            if (!result.success) {
                showToast(result.error, 'error');
            }
        });

        // Show Inventory link for admins only
        async function checkInventoryAccess() {
            const { user } = await getCurrentUser();
            if (user?.profile?.role === 'admin') {
                const inventoryNav = document.querySelector('.nav-inventory');
                if (inventoryNav) {
                    inventoryNav.style.display = 'block';
                }
            }
        }

        // Initialize
        checkInventoryAccess();
        loadDashboard();
        setupRealtime();
    </script>
</body>
</html>

