<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System Login</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="login-page">
    <div class="login-shell">
        <div class="login-hero">
            <div class="brand-mark">
                <div class="logo-chip">ABC</div>
                <div>
                    <p class="brand-name">ABC POS</p>
                    <span class="brand-tagline">Supabase Edition</span>
                </div>
            </div>
            <h1>Modern POS, Everywhere.</h1>
            <p class="hero-copy">
                Stay in sync with inventory, orders, and reports in real time. Secure authentication and
                mobile-friendly dashboards keep your store moving fast.
            </p>
            
            <ul class="hero-highlights">
                <li>
                    <span>âš¡</span>
                    Real-time updates with Supabase
                </li>
                <li>
                    <span>ðŸ“¦</span>
                    Smart inventory tracking
                </li>
                <li>
                    <span>ðŸ“ˆ</span>
                    Insightful sales reporting
                </li>
            </ul>

            <div class="hero-metrics">
                <div>
                    <p class="metric-value">5x</p>
                    <p class="metric-label">Faster checkouts</p>
                </div>
                <div>
                    <p class="metric-value">24/7</p>
                    <p class="metric-label">Cloud access</p>
                </div>
                <div>
                    <p class="metric-value">100%</p>
                    <p class="metric-label">Secure & RLS-protected</p>
                </div>
            </div>
        </div>

        <div class="login-panel">
            <div class="panel-header">
                <h2>Sign in to your workspace</h2>
                <p>Use your Supabase credentials to continue</p>
            </div>

            <div id="message"></div>
            
            <form id="loginForm" class="login-form">
                <div class="input-field">
                    <label for="email">Email address</label>
                    <input type="email" id="email" name="email" required autocomplete="username" placeholder="you@company.com">
                </div>
                
                <div class="input-field">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                
                <div class="input-field">
                    <label>Login as</label>
                    <div class="role-selection">
                        <label class="role-option">
                            <input type="radio" name="role" value="admin" required>
                            <span>Admin</span>
                        </label>
                        <label class="role-option">
                            <input type="radio" name="role" value="staff" required>
                            <span>Cashier</span>
                        </label>
                    </div>
                </div>

                <button type="submit" id="loginBtn">Continue</button>
            </form>

            <p class="support-note">
                Need access? Contact your administrator to create an account.
            </p>
        </div>
    </div>

    <script type="module">
        import { signIn, isAuthenticated } from './js/auth.js';
        import { showToast, showLoading, hideLoading } from './js/utils.js';

        // Check if already logged in
        async function checkAuth() {
            const authenticated = await isAuthenticated();
            if (authenticated) {
                // Get user role and redirect
                const { user } = await import('./js/auth.js').then(m => m.getCurrentUser());
                if (user?.profile?.role === 'admin') {
                    window.location.href = '/dashboard.html';
                } else {
                    // Redirect cashier to POS (Orders page)
                    window.location.href = '/orders.html';
                }
            }
        }

        checkAuth();

        // Check for logged_out parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('logged_out') === 'true') {
            showToast('You have been successfully logged out.', 'success');
            // Clean URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Handle form submission
        const loginForm = document.getElementById('loginForm');
        const messageDiv = document.getElementById('message');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const selectedRole = document.querySelector('input[name="role"]:checked')?.value;

            // Clear previous messages
            messageDiv.innerHTML = '';

            // Validate inputs
            if (!email || !password || !selectedRole) {
                showMessage('Please enter email, password, and select a role!', 'error');
                return;
            }

            // Show loading
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.textContent;
            loginBtn.textContent = 'Logging in...';
            loginBtn.disabled = true;

            try {
                // Sign in with Supabase
                const result = await signIn(email, password);

                if (!result.success) {
                    showMessage(result.error, 'error');
                    loginBtn.textContent = originalText;
                    loginBtn.disabled = false;
                    return;
                }

                // Check if selected role matches user's role
                const userRole = result.user.profile.role;
                if (selectedRole !== userRole) {
                    showMessage(
                        `Invalid role selected! Please select the correct role. Your account is: ${userRole.charAt(0).toUpperCase() + userRole.slice(1)}`,
                        'error'
                    );
                    loginBtn.textContent = originalText;
                    loginBtn.disabled = false;
                    return;
                }

                // Success! Redirect to appropriate dashboard
                showToast('Login successful!', 'success', 1000);
                
                setTimeout(() => {
                    if (userRole === 'admin') {
                        window.location.href = '/dashboard.html';
                    } else {
                        // Redirect cashier to POS (Orders page)
                        window.location.href = '/orders.html';
                    }
                }, 1000);

            } catch (error) {
                console.error('Login error:', error);
                showMessage('An unexpected error occurred. Please try again.', 'error');
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        });

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            const color = type === 'error' ? '#ff4444' : '#10b981';
            messageDiv.innerHTML = `<p style="color: ${color};">${message}</p>`;
        }
    </script>
</body>
</html>

