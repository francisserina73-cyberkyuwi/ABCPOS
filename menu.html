<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu | ABC POS</title>
    <link rel="stylesheet" href="menu.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>ABC POS</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <span class="nav-icon dashboard"></span>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="menu.html" class="nav-link active">
                        <span class="nav-icon menu"></span>
                        Menu
                    </a>
                </li>
                <li class="nav-item nav-inventory" style="display: none;">
                    <a href="inventory.html" class="nav-link">
                        <span class="nav-icon inventory"></span>
                        Inventory
                    </a>
                </li>
                <li class="nav-item">
                    <a href="reports.html" class="nav-link">
                        <span class="nav-icon reports"></span>
                        Reports
                    </a>
                </li>
                <li class="nav-item">
                    <a href="orders.html" class="nav-link">
                        <span class="nav-icon orders"></span>
                        Orders
                    </a>
                </li>
            </ul>
            
            <a href="#" class="logout-btn" id="logoutBtn">
                <span class="logout-icon"></span>
                Logout
            </a>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="content-header">
                <div class="header-left">
                    <a href="dashboard.html" class="back-btn">‚Üê</a>
                    <h2>Menu</h2>
                </div>
                <div class="header-right">
                    <button class="icon-btn">üîî</button>
                    <button class="icon-btn">üë§</button>
                    <div class="user-avatar">üë§</div>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">All Products</button>
                <button class="filter-tab" data-filter="popular">Popular Products</button>
                <button class="filter-tab" data-filter="desserts">Popular Desserts</button>
                <button class="btn-add-menu" id="addMenuBtn">Add Menu Item</button>
            </div>

            <!-- Products Table -->
            <div class="table-wrapper">
                <div class="table-header">
                    <h3>Product</h3>
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>Product Name</th>
                            <th>Item ID</th>
                            <th>Stock</th>
                            <th>Price</th>
                            <th>Availability</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="7" class="loading-cell">Loading products...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Menu Item</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <form id="productForm">
                <input type="hidden" id="productId">
                
                <div class="form-group">
                    <label for="productName">Product Name *</label>
                    <input type="text" id="productName" required>
                </div>

                <div class="form-group">
                    <label for="productDescription">Description</label>
                    <textarea id="productDescription" rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productPrice">Price *</label>
                        <input type="number" id="productPrice" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label for="productStock">Stock *</label>
                        <input type="number" id="productStock" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productCategory">Category *</label>
                        <select id="productCategory" required>
                            <option value="Pastry">Pastry</option>
                            <option value="Dessert">Dessert</option>
                            <option value="Beverage">Beverage</option>
                            <option value="General">General</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productStatus">Status *</label>
                        <select id="productStatus" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="draft">Draft</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="productPerishable">
                        Perishable Item
                    </label>
                </div>

                <div class="form-group">
                    <label for="productImage">Product Image</label>
                    <input type="file" id="productImage" accept="image/*">
                    <div id="imagePreview"></div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn-primary" id="submitBtn">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Delete Product</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button type="button" class="btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { requireAuth, signOut } from './js/auth.js';
        import { getProducts, createProduct, updateProduct, deleteProduct } from './js/api.js';
        import { uploadImage } from './js/storage.js';
        import { supabase } from './js/supabase-client.js';
        import { formatCurrency, showToast, confirm } from './js/utils.js';

        // Protect page
        await requireAuth();

        let allProducts = [];
        let editingProductId = null;
        let deleteProductId = null;
        let currentFilter = 'all';

        // Load products
        async function loadProducts() {
            const { data, error } = await getProducts();
            if (error) {
                showToast('Failed to load products', 'error');
                return;
            }
            allProducts = data || [];
            applyFilter();
        }

        // Apply filter
        function applyFilter() {
            let filtered = allProducts;

            if (currentFilter === 'popular') {
                // Show products with stock > 50 (popular items)
                filtered = filtered.filter(p => p.stock > 50 && p.status === 'active');
            } else if (currentFilter === 'desserts') {
                // Show only desserts
                filtered = filtered.filter(p => p.category === 'Dessert' && p.status === 'active');
            }

            renderProducts(filtered);
        }

        // Render products
        function renderProducts(products) {
            const tbody = document.getElementById('productsTableBody');
            
            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-cell">No products found</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => {
                const availability = product.stock > 0 ? 'In Stock' : 'Out of Stock';
                const availabilityClass = product.stock > 0 ? 'text-success' : 'text-danger';

                return `
                    <tr>
                        <td><input type="checkbox" class="row-checkbox"></td>
                        <td>
                            <div class="product-cell">
                                <img src="${product.image_path || 'https://via.placeholder.com/50'}" 
                                     alt="${product.name}"
                                     class="product-image"
                                     onerror="this.src='https://via.placeholder.com/50'">
                                <div class="product-info">
                                    <div class="product-name">${product.name}</div>
                                    <div class="product-description">${product.description || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td class="item-id">#${product.id}</td>
                        <td>${product.stock} items</td>
                        <td class="product-price">${formatCurrency(product.price)}</td>
                        <td><span class="${availabilityClass}">${availability}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="window.editProduct(${product.id})" title="Edit">‚úèÔ∏è</button>
                                <button class="action-btn delete-btn" onclick="window.deleteProductPrompt(${product.id})" title="Delete">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Show modal
        function showModal(title, product = null) {
            editingProductId = product?.id || null;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').innerHTML = '';

            if (product) {
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productStatus').value = product.status;
                document.getElementById('productPerishable').checked = product.perishable;

                if (product.image_path) {
                    document.getElementById('imagePreview').innerHTML = `
                        <img src="${product.image_path}" alt="Preview" style="max-width: 200px; margin-top: 10px; border-radius: 8px;">
                    `;
                }
            }

            document.getElementById('productModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
            editingProductId = null;
        }

        // Delete modal
        window.deleteProductPrompt = (id) => {
            deleteProductId = id;
            document.getElementById('deleteModal').classList.add('active');
        };

        window.closeDeleteModal = () => {
            document.getElementById('deleteModal').classList.remove('active');
            deleteProductId = null;
        };

        // Edit product
        window.editProduct = async (id) => {
            const product = allProducts.find(p => p.id === id);
            if (product) {
                showModal('Edit Product', product);
            }
        };

        // Confirm delete
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deleteProductId) return;

            const result = await deleteProduct(deleteProductId);
            if (result.error) {
                showToast(result.error, 'error');
            } else {
                showToast('Product deleted successfully', 'success');
                loadProducts();
            }
            window.closeDeleteModal();
        });

        // Handle form submit
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                // Upload image if selected
                let imagePath = null;
                const imageFile = document.getElementById('productImage').files[0];
                if (imageFile) {
                    const uploadResult = await uploadImage(imageFile, 'products');
                    if (uploadResult.success) {
                        imagePath = uploadResult.url;
                    }
                }

                const productData = {
                    name: document.getElementById('productName').value,
                    description: document.getElementById('productDescription').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    category: document.getElementById('productCategory').value,
                    status: document.getElementById('productStatus').value,
                    perishable: document.getElementById('productPerishable').checked
                };

                if (imagePath) {
                    productData.image_path = imagePath;
                }

                let result;
                if (editingProductId) {
                    result = await updateProduct(editingProductId, productData);
                } else {
                    result = await createProduct(productData);
                }

                if (result.error) {
                    showToast(result.error, 'error');
                } else {
                    showToast(`Product ${editingProductId ? 'updated' : 'created'} successfully`, 'success');
                    closeModal();
                    loadProducts();
                }
            } catch (error) {
                console.error('Form submit error:', error);
                showToast('Failed to save product', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Product';
            }
        });

        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                applyFilter();
            });
        });

        // Select all checkbox
        document.getElementById('selectAll').addEventListener('change', (e) => {
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = e.target.checked;
            });
        });

        // Event listeners
        document.getElementById('addMenuBtn').addEventListener('click', () => showModal('Add Menu Item'));
        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut();
        });

        // Real-time updates
        supabase
            .channel('menu-products')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => {
                loadProducts();
            })
            .subscribe();

        // Show Inventory link for admins only
        async function checkInventoryAccess() {
            const { user } = await getCurrentUser();
            if (user?.profile?.role === 'admin') {
                const inventoryNav = document.querySelector('.nav-inventory');
                if (inventoryNav) {
                    inventoryNav.style.display = 'block';
                }
            }
        }

        // Initialize
        checkInventoryAccess();
        loadProducts();
    </script>
</body>
</html>
